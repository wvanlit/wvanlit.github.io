---
// Simple light/dark toggle that sets `data-theme` on <html> and persists to localStorage.
---

<button type="button" class="theme-toggle" aria-label="Toggle theme" title="Toggle theme">
  <span class="icon" aria-hidden="true">
    <!-- Moon (for light mode -> switch to dark) -->
    <svg class="moon" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
    </svg>
    <!-- Sun (for dark mode -> switch to light) -->
    <svg class="sun" viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="4" />
      <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41" />
    </svg>
  </span>
  <span class="label">Theme</span>
</button>

<script is:inline>
  let btn = (document.currentScript && document.currentScript.previousElementSibling) || null;
  if (!(btn instanceof HTMLElement)) {
    btn = document.querySelector('.theme-toggle');
  }
  const storageKey = 'theme'; // 'light' | 'dark'

  function getEffectiveTheme() {
    const attr = document.documentElement.getAttribute('data-theme');
    if (attr === 'light' || attr === 'dark') return attr;
    return matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function setTheme(next) {
    document.documentElement.setAttribute('data-theme', next);
    try { localStorage.setItem(storageKey, next); } catch {}
    updateButton(next);
  }

  function updateButton(mode) {
    if (!btn || !(btn instanceof HTMLElement)) return;
    btn.setAttribute('aria-pressed', mode === 'dark' ? 'true' : 'false');
    try { btn.dataset.mode = mode; } catch {}
  }

  // Initialize
  updateButton(getEffectiveTheme());

  // Toggle on click
  btn?.addEventListener('click', () => {
    const current = getEffectiveTheme();
    const next = current === 'dark' ? 'light' : 'dark';
    setTheme(next);
  });
</script>

<style>
  .theme-toggle {
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    padding: .35rem .55rem;
    border: 1px solid var(--border);
    background: var(--muted);
    color: var(--fg);
    border-radius: .5rem;
    cursor: pointer;
  }
  .theme-toggle:hover { background: color-mix(in oklab, var(--muted), var(--bg)); }
  .theme-toggle:focus { outline: 2px solid var(--link); outline-offset: 2px; }
  .icon { line-height: 0; display: inline-grid; }
  .sun, .moon { display: none; }
  /* Show moon icon when light mode active (offer switch to dark), sun in dark */
  :global(html[data-theme="light"]) .theme-toggle .moon { display: block; }
  :global(html[data-theme="dark"]) .theme-toggle .sun { display: block; }
  /* If no explicit theme, fall back to media preference for icon */
  @media (prefers-color-scheme: light) {
    :global(html:not([data-theme])) .theme-toggle .moon { display: block; }
  }
  @media (prefers-color-scheme: dark) {
    :global(html:not([data-theme])) .theme-toggle .sun { display: block; }
  }
  .label { font-size: .85rem; color: var(--muted-fg); }
  @media (max-width: 520px) { .label { display: none; } }
</style>
